FROM python:3.11-slim

# Install system dependencies
RUN apt-get update \
 && apt-get install -y --no-install-recommends gcc libffi-dev libssl-dev curl ca-certificates \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Create and set working directory
WORKDIR /app

# Copy requirements.txt
COPY requirements.txt ./

# Copy your local CA cert into the container (if it exists) -- use for local testing only
COPY cacert.pem /tmp/cacert.pem

# Ensure Python/requests uses proper CA certs  -- use for local testing only
ENV SSL_CERT_FILE="/tmp/cacert.pem"
ENV REQUESTS_CA_BUNDLE="/tmp/cacert.pem"

# Install the specified packages
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt

# Set environment variables for better Python behavior in containers
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Copy function code
COPY . .

# Expose port
EXPOSE 8080

# Set the CMD to your handler
CMD ["functions-framework", "--target=generate_map", "--port=8080"]